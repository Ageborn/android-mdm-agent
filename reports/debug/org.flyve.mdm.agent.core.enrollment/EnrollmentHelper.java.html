<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EnrollmentHelper.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">org.flyve.mdm.agent.core.enrollment</a> &gt; <span class="el_source">EnrollmentHelper.java</span></div><h1>EnrollmentHelper.java</h1><pre class="source lang-java linenums">package org.flyve.mdm.agent.core.enrollment;

import android.content.Context;
import android.os.Handler;
import android.os.Looper;

import org.flyve.mdm.agent.R;
import org.flyve.mdm.agent.core.Routes;
import org.flyve.mdm.agent.data.DataStorage;
import org.flyve.mdm.agent.security.AndroidCryptoProvider;
import org.flyve.mdm.agent.utils.ConnectionHTTP;
import org.flyve.mdm.agent.utils.FlyveLog;
import org.flyve.mdm.agent.utils.Helpers;
import org.json.JSONArray;
import org.json.JSONObject;

import java.util.HashMap;

import static org.flyve.mdm.agent.utils.ConnectionHTTP.getSyncWebData;

/*
 *   Copyright (C) 2017 Teclib. All rights reserved.
 *
 *   This file is part of flyve-mdm-android-agent
 *
 * flyve-mdm-android-agent is a subproject of Flyve MDM. Flyve MDM is a mobile
 * device management software.
 *
 * Flyve MDM is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 3
 * of the License, or (at your option) any later version.
 *
 * Flyve MDM is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * ------------------------------------------------------------------------------
 * @author    Rafael Hernandez
 * @date      12/7/17
 * @copyright Copyright (C) 2017 Teclib. All rights reserved.
 * @license   GPLv3 https://www.gnu.org/licenses/gpl-3.0.html
 * @link      https://github.com/flyve-mdm/flyve-mdm-android-agent
 * @link      https://flyve-mdm.com
 * ------------------------------------------------------------------------------
 */
public class EnrollmentHelper {

    private static Handler uiHandler;
    
    private static final String SESSION_TOKEN = &quot;Session-Token&quot;;
    private static final String ACCEPT = &quot;Accept&quot;;
    private static final String APPLICATION_JSON = &quot;application/json&quot;;
    private static final String CONTENT_TYPE = &quot;Content-Type&quot;;
    private static final String CHARSET = &quot;charset=UTF-8&quot;;
    private static final String USER_AGENT = &quot;User-Agent&quot;;
    private static final String FLYVE_MDM = &quot;Flyve MDM&quot;;
    private static final String REFERER = &quot;Referer&quot;;

    static {
<span class="nc" id="L61">        uiHandler = new Handler(Looper.getMainLooper());</span>
<span class="nc" id="L62">    }</span>

    private static void runOnUI(Runnable runnable) {
<span class="nc" id="L65">        uiHandler.post(runnable);</span>
<span class="nc" id="L66">    }</span>

    private Context context;
    private DataStorage cache;
    private Routes routes;

    /**
     * This constructor loads the context of the current class
     * @param context of the class
     */
<span class="nc" id="L76">    public EnrollmentHelper(Context context) {</span>
<span class="nc" id="L77">        this.context = context;</span>
<span class="nc" id="L78">        cache = new DataStorage(context);</span>
<span class="nc" id="L79">        routes = new Routes(context);</span>
<span class="nc" id="L80">    }</span>

    /**
     * Manage the errors 
     * @param error
     * @return string the message of the error
     */
    private String manageError(String error) {
<span class="nc" id="L88">        String errorMessage = &quot;&quot;;</span>

<span class="nc bnc" id="L90" title="All 4 branches missed.">        if(error.contains(&quot;EXCEPTION_HTTP&quot;) || error.contains(&quot;ERROR&quot;)) {</span>
<span class="nc" id="L91">            FlyveLog.e(error);</span>

<span class="nc" id="L93">            errorMessage = context.getResources().getString(R.string.ERROR_INTERNAL);</span>

<span class="nc bnc" id="L95" title="All 2 branches missed.">            if(error.contains(&quot;EXCEPTION_HTTP&quot;)) {</span>
<span class="nc" id="L96">                return errorMessage;</span>
            }

            // Manage error from backend
            // Example: [&quot;ERROR_SESSION_TOKEN_MISSING&quot;,&quot;parameter session_token is missing or empty; View documentation in your browser at https://dev.flyve.org/glpi/apirest.php/#ERROR_SESSION_TOKEN_MISSING&quot;]
            try {
<span class="nc" id="L102">                JSONArray jError = new JSONArray(error);</span>
<span class="nc" id="L103">                errorMessage = jError.getString(1);</span>

<span class="nc" id="L105">                String[] errorArray = errorMessage.split(&quot;;&quot;);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                if(errorArray.length &gt; 0) {</span>
<span class="nc" id="L107">                    errorMessage = errorArray[0];</span>
                }
<span class="nc" id="L109">            } catch (Exception ex) {</span>
<span class="nc" id="L110">                FlyveLog.e(ex.getMessage());</span>
<span class="nc" id="L111">            }</span>

<span class="nc" id="L113">            return errorMessage;</span>
        }

<span class="nc" id="L116">        return errorMessage;</span>
    }

    /**
     * Get session token
     */
    public void getActiveSessionToken(final EnrollCallBack callback) {

<span class="nc" id="L124">        Thread t = new Thread(new Runnable()</span>
<span class="nc" id="L125">        {</span>
            public void run()
            {
                try {
                    // STEP 1 get session token
<span class="nc" id="L130">                    final String data = getSyncWebData(routes.initSession(cache.getUserToken()), &quot;GET&quot;, null);</span>

<span class="nc" id="L132">                    final String errorMessage = manageError(data);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                    if(!errorMessage.equals(&quot;&quot;)) {</span>
<span class="nc" id="L134">                        EnrollmentHelper.runOnUI(new Runnable() {</span>
                            public void run() {
<span class="nc" id="L136">                                callback.onError(errorMessage);</span>
<span class="nc" id="L137">                            }</span>
                        });
<span class="nc" id="L139">                        return;</span>
                    }

<span class="nc" id="L142">                    JSONObject jsonSession = new JSONObject(data);</span>
<span class="nc" id="L143">                    cache.setSessionToken(jsonSession.getString(&quot;session_token&quot;));</span>

                    // STEP 2 get full session information
<span class="nc" id="L146">                    HashMap&lt;String, String&gt; header = new HashMap();</span>
<span class="nc" id="L147">                    header.put(SESSION_TOKEN,cache.getSessionToken());</span>
<span class="nc" id="L148">                    header.put(ACCEPT,APPLICATION_JSON);</span>
<span class="nc" id="L149">                    header.put(CONTENT_TYPE,APPLICATION_JSON + &quot;;&quot; + CHARSET);</span>
<span class="nc" id="L150">                    header.put(USER_AGENT,FLYVE_MDM);</span>
<span class="nc" id="L151">                    header.put(REFERER,routes.getFullSession());</span>

<span class="nc" id="L153">                    final String dataFullSession = getSyncWebData(routes.getFullSession(), &quot;GET&quot;, header);</span>
<span class="nc" id="L154">                    final String errorMessageFullSession = manageError(dataFullSession);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                    if(!errorMessageFullSession.equals(&quot;&quot;)) {</span>
<span class="nc" id="L156">                        EnrollmentHelper.runOnUI(new Runnable() {</span>
                            public void run() {
<span class="nc" id="L158">                                callback.onError(errorMessageFullSession);</span>
<span class="nc" id="L159">                            }</span>
                        });
<span class="nc" id="L161">                        return;</span>
                    }

<span class="nc" id="L164">                    JSONObject jsonFullSession = new JSONObject(dataFullSession);</span>
<span class="nc" id="L165">                    jsonSession = jsonFullSession.getJSONObject(&quot;session&quot;);</span>
<span class="nc" id="L166">                    String profileId = jsonSession.getString(&quot;plugin_flyvemdm_guest_profiles_id&quot;);</span>

<span class="nc" id="L168">                    cache.setProfileId( profileId );</span>

                    // STEP 3 Activated the profile
<span class="nc" id="L171">                    final String dataActiveProfile = getSyncWebData(routes.changeActiveProfile(cache.getProfileId()), &quot;POST&quot;, header);</span>
<span class="nc" id="L172">                    final String errorActiveProfile = manageError(dataActiveProfile);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                    if(!errorActiveProfile.equals(&quot;&quot;)) {</span>
<span class="nc" id="L174">                        EnrollmentHelper.runOnUI(new Runnable() {</span>
                            public void run() {
<span class="nc" id="L176">                                callback.onError(errorActiveProfile);</span>
<span class="nc" id="L177">                            }</span>
                        });
                    } else {
                        // Success
<span class="nc" id="L181">                        EnrollmentHelper.runOnUI(new Runnable() {</span>
                            public void run() {
<span class="nc" id="L183">                                callback.onSuccess(cache.getSessionToken());</span>
<span class="nc" id="L184">                            }</span>
                        });
                    }
<span class="nc" id="L187">                } catch (final Exception ex) {</span>
<span class="nc" id="L188">                    FlyveLog.e(ex.getMessage());</span>
<span class="nc" id="L189">                    EnrollmentHelper.runOnUI(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L191">                            callback.onError(context.getResources().getString(R.string.ERROR_INTERNAL));</span>
<span class="nc" id="L192">                        }</span>
                    });
<span class="nc" id="L194">                }</span>
<span class="nc" id="L195">            }</span>
        });
<span class="nc" id="L197">        t.start();</span>
<span class="nc" id="L198">    }</span>

    /**
     * Get the information to enroll
     * @param payload the information of the phone
     * @param callback
     */
    public void enrollment(final JSONObject payload, final EnrollCallBack callback) {
<span class="nc" id="L206">        Thread t = new Thread(new Runnable()</span>
<span class="nc" id="L207">        {</span>
            public void run()
            {
                try {
<span class="nc" id="L211">                    HashMap&lt;String, String&gt; header = new HashMap();</span>
<span class="nc" id="L212">                    header.put(SESSION_TOKEN,cache.getSessionToken());</span>

<span class="nc" id="L214">                    header.put(ACCEPT,APPLICATION_JSON);</span>
<span class="nc" id="L215">                    header.put(CONTENT_TYPE,APPLICATION_JSON + &quot;;&quot; + CHARSET);</span>

<span class="nc" id="L217">                    JSONObject input = new JSONObject();</span>
<span class="nc" id="L218">                    input.put(&quot;input&quot;, payload);</span>

<span class="nc" id="L220">                    String data = getSyncWebData(routes.pluginFlyvemdmAgent(), input, header);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                    if(data.contains(&quot;ERROR&quot;)){</span>
<span class="nc" id="L222">                        JSONArray jsonArr = new JSONArray(data);</span>
<span class="nc" id="L223">                        final String msgError = jsonArr.get(1).toString();</span>
<span class="nc" id="L224">                        FlyveLog.e(msgError + &quot; - Device serial: &quot; + Helpers.getDeviceSerial());</span>

<span class="nc" id="L226">                        EnrollmentHelper.runOnUI(new Runnable() {</span>
                            public void run() {
<span class="nc" id="L228">                                callback.onError(msgError);</span>
<span class="nc" id="L229">                            }</span>
                        });
<span class="nc" id="L231">                    } else {</span>
<span class="nc" id="L232">                        JSONObject jsonAgent = new JSONObject(data);</span>
<span class="nc" id="L233">                        cache.setAgentId(jsonAgent.getString(&quot;id&quot;));</span>

<span class="nc" id="L235">                        header = new HashMap();</span>
<span class="nc" id="L236">                        header.put(SESSION_TOKEN,cache.getSessionToken());</span>
<span class="nc" id="L237">                        header.put(ACCEPT,APPLICATION_JSON);</span>
<span class="nc" id="L238">                        header.put(CONTENT_TYPE,APPLICATION_JSON + &quot;;&quot; + CHARSET);</span>
<span class="nc" id="L239">                        header.put(USER_AGENT,FLYVE_MDM);</span>
<span class="nc" id="L240">                        header.put(REFERER,routes.pluginFlyvemdmAgent());</span>

<span class="nc" id="L242">                        String dataAgent = ConnectionHTTP.getSyncWebData(routes.pluginFlyvemdmAgent(cache.getAgentId()), &quot;GET&quot;, header);</span>

<span class="nc" id="L244">                        JSONObject jsonObject = new JSONObject(dataAgent);</span>

<span class="nc" id="L246">                        String mbroker = jsonObject.getString(&quot;broker&quot;);</span>
<span class="nc" id="L247">                        String mport = jsonObject.getString(&quot;port&quot;);</span>
<span class="nc" id="L248">                        String mssl = jsonObject.getString(&quot;tls&quot;);</span>
<span class="nc" id="L249">                        String mtopic = jsonObject.getString(&quot;topic&quot;);</span>
<span class="nc" id="L250">                        String mpassword = jsonObject.getString(&quot;mqttpasswd&quot;);</span>
<span class="nc" id="L251">                        String mcert = jsonObject.getString(&quot;certificate&quot;);</span>
<span class="nc" id="L252">                        String mNameEmail = jsonObject.getString(&quot;name&quot;);</span>
<span class="nc" id="L253">                        int mComputersId = jsonObject.getInt(&quot;computers_id&quot;);</span>
<span class="nc" id="L254">                        int mId = jsonObject.getInt(&quot;id&quot;);</span>
<span class="nc" id="L255">                        FlyveLog.d(&quot;Id: &quot; + mId);</span>
<span class="nc" id="L256">                        int mEntitiesId = jsonObject.getInt(&quot;entities_id&quot;);</span>
<span class="nc" id="L257">                        int mFleetId = jsonObject.getInt(&quot;plugin_flyvemdm_fleets_id&quot;);</span>

                        // Agent information
<span class="nc" id="L260">                        cache.setBroker( mbroker );</span>
<span class="nc" id="L261">                        cache.setPort( mport );</span>
<span class="nc" id="L262">                        cache.setTls( mssl );</span>
<span class="nc" id="L263">                        cache.setTopic( mtopic );</span>
<span class="nc" id="L264">                        cache.setMqttuser( Helpers.getDeviceSerial() );</span>
<span class="nc" id="L265">                        cache.setMqttpasswd( mpassword );</span>
<span class="nc" id="L266">                        cache.setCertificate( mcert );</span>
<span class="nc" id="L267">                        cache.setName( mNameEmail );</span>
<span class="nc" id="L268">                        cache.setComputersId( String.valueOf(mComputersId) );</span>
<span class="nc" id="L269">                        cache.setEntitiesId( String.valueOf(mEntitiesId) );</span>
<span class="nc" id="L270">                        cache.setPluginFlyvemdmFleetsId( String.valueOf(mFleetId) );</span>

<span class="nc" id="L272">                        EnrollmentHelper.runOnUI(new Runnable() {</span>
                            public void run() {
<span class="nc" id="L274">                                callback.onSuccess(&quot;success&quot;);</span>
<span class="nc" id="L275">                            }</span>
                        });
                    }

<span class="nc" id="L279">                } catch (Exception ex) {</span>
<span class="nc" id="L280">                    final String error  = ex.getMessage();</span>
<span class="nc" id="L281">                    FlyveLog.e(error);</span>
<span class="nc" id="L282">                    EnrollmentHelper.runOnUI(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L284">                            callback.onError(context.getResources().getString(R.string.ERROR_INTERNAL));</span>
<span class="nc" id="L285">                        }</span>
                    });
<span class="nc" id="L287">                }</span>
<span class="nc" id="L288">            }</span>
        });
<span class="nc" id="L290">        t.start();</span>
<span class="nc" id="L291">    }</span>

    /**
     * Create X509 certificate
     */
    public void createX509cert(final EnrollCallBack callback) {
<span class="nc" id="L297">        new Thread(new Runnable() {</span>
            public void run() {
                try {
<span class="nc" id="L300">                    AndroidCryptoProvider createCertificate = new AndroidCryptoProvider(context);</span>
<span class="nc" id="L301">                    createCertificate.generateRequest(new AndroidCryptoProvider.GenerateCallback() {</span>
                        @Override
                        public void onGenerate(final boolean work) {
<span class="nc" id="L304">                            EnrollmentHelper.runOnUI(new Runnable() {</span>
                                public void run() {
<span class="nc bnc" id="L306" title="All 2 branches missed.">                                    if(work) {</span>
<span class="nc" id="L307">                                        callback.onSuccess(&quot;true&quot;);</span>
                                    }
<span class="nc" id="L309">                                }</span>
                            });
<span class="nc" id="L311">                        }</span>
                    });
<span class="nc" id="L313">                } catch (Exception ex) {</span>
<span class="nc" id="L314">                    FlyveLog.e(ex.getMessage());</span>
<span class="nc" id="L315">                    EnrollmentHelper.runOnUI(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L317">                            callback.onError(&quot;false&quot;);</span>
<span class="nc" id="L318">                        }</span>
                    });
<span class="nc" id="L320">                }</span>
<span class="nc" id="L321">            }</span>
<span class="nc" id="L322">        }).start();</span>
<span class="nc" id="L323">    }</span>

    public interface EnrollCallBack {
        void onSuccess(String data);
        void onError(String error);
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span>Generated by the Android Gradle plugin 2.3.3</div></body></html>